import math
import matplotlib.pyplot as plt

def calculate_basic_clothoid(s_length):
    clothoid_points = []
    dt = 0.01  # Step size for numerical integration
    t = 0.0

    while t <= s_length:
        x = t * math.cos(t * t / 2)
        y = t * math.sin(t * t / 2)
        clothoid_points.append((x, y))
        t += dt

    return clothoid_points

def reflect_point_across_normal(point, merging_point,tangent_angle):
    x, y = point
    x_merge, y_merge = merging_point
    
    #tangent_angle = bias + math.atan2( y_merge, -x_merge)
    normal_x = math.cos( math.pi/2 +tangent_angle)
    normal_y = math.sin( math.pi/2 +tangent_angle)

    dx = x - x_merge
    dy = y - y_merge

    # Calculate the dot product of the vector and the normal
    dot_product = dx * normal_x + dy * normal_y

    # Project the vector onto the normal
    projected_x = dot_product * normal_x
    projected_y = dot_product * normal_y
    
    origin_ref_x = projected_x + (projected_x - dx)
    origin_ref_y = projected_y + (projected_y - dy)
    
    reflected_x = origin_ref_x + x_merge
    reflected_y = origin_ref_y + y_merge
    return reflected_x, reflected_y

def symmetric_clothoid(first_clothoid_points):
    clothoid_points = []
    scale = 1.2
    for point in first_clothoid_points:
      point_x = point[0] *scale
      point_y = point[1]*scale
      clothoid_points.append((point_x, point_y))
    
    merging_point = clothoid_points[-1]
    before_merg = clothoid_points[-2]
    pseudo_tangent_x = before_merg[0] -merging_point[0]
    pseudo_tangent_y = before_merg[1] -merging_point[1]
    pseudo_tangent_vec = [pseudo_tangent_x, pseudo_tangent_y]
    tangent_angle = math.atan2(pseudo_tangent_y,pseudo_tangent_x)

    symmetric_clothoid_points = [reflect_point_across_normal(point, merging_point,tangent_angle)
                                 for point in reversed(clothoid_points)]

    merged_clothoid_points =clothoid_points+ symmetric_clothoid_points

    return merged_clothoid_points

def Clockwise_Merged_Clothoid(merged_clothoid_points):
  clockwise_merged_clothoid = []
  for point in merged_clothoid_points:
    point_x = point[0] 
    point_y = -point[1] 
    clockwise_merged_clothoid.append((point_x,point_y))
  
  return clockwise_merged_clothoid
  


# Define the length of the clothoid
s_length = 1



# Calculate the basic and symmetric clothoid points
basic_clothoid_points = calculate_basic_clothoid(s_length)

symmetric_clothoid_points = symmetric_clothoid(basic_clothoid_points)

clockwise_merged_clothoid =  Clockwise_Merged_Clothoid(symmetric_clothoid_points)

# Extract x and y coordinates for plotting
basic_clothoid_x, basic_clothoid_y = zip(*basic_clothoid_points)
symmetric_clothoid_x, symmetric_clothoid_y = zip(*symmetric_clothoid_points)
clockwise_merged_clothoid_x, clockwise_merged_clothoid_y = zip(*clockwise_merged_clothoid)
# Plot the clothoids
plt.figure(figsize=(8, 6))
plt.plot(basic_clothoid_x, basic_clothoid_y, label="Basic Clothoid")
plt.plot(symmetric_clothoid_x, symmetric_clothoid_y, label="Symmetric Clothoid")
plt.plot(clockwise_merged_clothoid_x, clockwise_merged_clothoid_y, label="Anticlockwise Merged Clothoid")
plt.xlabel("x")
plt.ylabel("y")
plt.title("Clothoid and Symmetric Clothoid")
plt.legend()
plt.grid(True)
plt.axis("equal")
plt.show()
